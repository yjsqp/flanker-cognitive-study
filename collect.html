<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flanker Cognitive Study</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f4f6fb;margin:0;text-align:center}
.topbar{
  position:fixed;top:0;width:100%;
  background:#222;color:white;padding:6px 8px;
  display:flex;justify-content:space-between;align-items:center;font-size:14px
}
.topbar-title{
  font-weight:600;
  font-size:15px
}
.topbar-center{
  flex:1;
  text-align:center
}
.topbar-right{
  display:flex;
  align-items:center;
  gap:10px
}
.topbar button{
  padding:4px 12px;
  font-size:13px;
  margin:5px 20px;
}
.card{
  background:white;width:900px;margin:35px auto 10px;
  padding:20px;border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.12);
  max-height:610px;
  overflow-y:auto
}
h2{color:#2c3e50;margin-top:0;margin-bottom:15px;font-size:24px;font-weight:600}
h3{color:#34495e;font-size:16px;font-weight:600;margin-top:0;margin-bottom:8px}
.flanker{font-size:70px;letter-spacing:12px}
.feedback{height:26px;margin-top:10px;font-size:20px}
input,select{
  padding:6px 10px;
  border:2px solid #e0e0e0;
  border-radius:6px;
  font-size:14px;
  transition:border-color 0.2s;
  width:200px;
  box-sizing:border-box;
  background:white
}
select{
  cursor:pointer
}
input:focus,select:focus{
  outline:none;
  border-color:#4a90e2;
  box-shadow:0 0 0 3px rgba(74,144,226,0.1)
}
label{
  color:#555;
  font-weight:500;
  font-size:14px
}
button{
  padding:8px 20px;
  background:#4a90e2;
  color:white;
  border:none;
  border-radius:6px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:background 0.2s;
  margin-top:10px
}
button:hover{
  background:#357abd
}
button:active{
  transform:translateY(1px)
}
.section{
  background:#fafbfc;
  padding:12px;
  border-radius:8px;
  margin-bottom:12px;
  border:1px solid #e8eaed
}
.form-group{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:8px
}
.form-group label{
  min-width:200px;
  text-align:right;
  line-height:1.3
}
.centered-form{
  display:flex;
  justify-content:center
}
.description{
  font-size:12px;
  color:#7f8c8d;
  margin-top:4px;
  margin-left:215px;
  font-style:italic
}
canvas{margin-top:20px}
</style>
</head>

<body>

<div class="topbar">
  <div class="topbar-title">Flanker Cognitive Study</div>
  <div class="topbar-center">
    <div id="pidDisplay" style="font-weight:700"></div>
    <div id="status" style="font-size:12px;color:#ddd"></div>
  </div>
  <div class="topbar-right">
    <span id="clock">0:00</span>
    <button id="pauseBtn" onclick="togglePause()">Pause</button>
  </div>
</div>

<div id="app"></div>

<script>
/* ================= PLAYLISTS ================= */
const PLAYLISTS=[
 {name:"Mixed Visuals",id:"https://www.youtube.com/embed/videoseries?si=6tlxmLSYZ0EVUzeC&amp;list=PLP_1XwSHt55uK_h6bTkttB80SmlwiDvpI"},
 {name:"Fast Cuts",id:"https://www.youtube.com/embed/eQbSiMBrLPw"},
 {name:"Nature Calm",id:"https://www.youtube.com/embed/eQbSiMBrLPw"},
];

/* ================= GLOBALS ================= */
let pid="P"+Math.floor(Math.random()*1000000);
let SETTINGS={}, DEMO={};
let trialsData=[];
let summaryData=null;
let paused=false, timerInt, seconds=0;
let blockTotal=0, blockIndex=0;

const app=document.getElementById("app");
const status=document.getElementById("status");

/* ================= UI ================= */
function screen(h){app.innerHTML=`<div class="card">${h}</div>`}
function wait(ms){return new Promise(r=>setTimeout(r,ms))}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}

function updateStatus(t=""){ const s = document.getElementById('status'); if(s) s.innerText = t }

function updateProgress(t=""){ const cp = document.getElementById('cardProgress'); if(cp) cp.innerText = t; else { const p = document.getElementById('progress'); if(p) p.innerText = t } }

// show pid in topbar center
const pidDisplay = document.getElementById('pidDisplay'); if(pidDisplay) pidDisplay.innerText = pid;

/* ================= TIMER ================= */
function startTimer(){
  timerInt=setInterval(()=>{
    if(!paused){
      seconds++;
      clock.innerText=Math.floor(seconds/60)+":"+String(seconds%60).padStart(2,"0");
    }
  },1000);
}
function stopTimer(){clearInterval(timerInt)}
function togglePause(){paused=!paused}

/* ================= SETUP ================= */
function setupScreen(){
 let opts=PLAYLISTS.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");

 screen(`
 <h2>Setup</h2>
 
 <div class="section">
   <h3>Number of Test Trials</h3>
   <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
     <div class="form-group">
       <label>Practice<br><span style="font-weight:normal;font-size:0.9em;">(training)</span></label>
       <input id="pN" value="5" type="number">
     </div>
     <div class="form-group">
       <label>Baseline<br><span style="font-weight:normal;font-size:0.9em;">(before exposed stimuli)</span></label>
       <input id="bN" value="25" type="number">
     </div>
     <div class="form-group">
       <label>Postâ€‘Exposure<br><span style="font-weight:normal;font-size:0.9em;">(after exposed stimuli)</span></label>
       <input id="postN" value="25" type="number">
     </div>
     <div class="form-group">
       <label>Recovery<br><span style="font-weight:normal;font-size:0.9em;">(after short rest)</span></label>
       <input id="rN" value="25" type="number">
     </div>
   </div>
 </div>

 <div class="section">
   <h3>Task Difficulty</h3>
   <div class="centered-form">
    <div class="form-group">
      <label>Easy trials<br><span style="font-weight:normal;font-size:0.9em;">(Congruent %)</span></label>
      <input id="pct" value="50" type="number" min="0" max="100">
    </div>
    <div class="form-group">
      <label>Recovery wait (s)<br><span style="font-weight:normal;font-size:0.9em;">(pause before recovery)</span></label>
      <input id="recoveryDelay" value="120" type="number" min="0">
    </div>
   </div>
   <p class="description" style="text-align:center;margin-left:0;">Remainings are Hard trials (Incongruent)</p>
 </div>

 <div class="section">
   <h3>Rapid Change Stimuli Exposure</h3>
   <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
     <div class="form-group">
       <label>Rapid Change Stimuli Type</label>
       <select id="pl">${opts}</select>
     </div>
     <div class="form-group">
       <label>Exposure minutes</label>
       <input id="mins" value="5" type="number" min="1">
     </div>
   </div>
 </div>

 <button onclick="saveSetup()">Next</button>
 `);
}

function saveSetup(){
 SETTINGS={
   playlist:pl.value,
   practice:+pN.value,
   baseline:+bN.value,
   post:+postN.value,
   recovery:+rN.value,
   pct:+pct.value,
   minutes:+mins.value,
   recoveryDelay:+recoveryDelay.value
 };
 demographics();
}

/* ================= DEMOGRAPHICS ================= */
function demographics(){

 screen(`
 <h2>Participant Info</h2>

 <div class="section">
   <div class="form-group">
     <label>Age</label>
     <input id="age" type="number" min="5" max="100" placeholder="Enter age">
   </div>

   <div class="form-group">
     <label>Gender</label>
     <select id="gender">
       <option value="">Select...</option>
       <option>Male</option>
       <option>Female</option>
       <option>Skip</option>
     </select>
   </div>

   <div class="form-group">
     <label>Grade</label>
     <select id="grade">
       <option value="">Select...</option>
       <option>KG</option>
       ${Array.from({length:12},(_,i)=>`<option>G${i+1}</option>`).join("")}
       <option>College</option>
       <option>Work</option>
       <option>Skip</option>
     </select>
   </div>
 </div>

 <div class="section">
   <div class="form-group">
     <label>Daily screen time (hrs)</label>
     <input id="screenTime" type="number" step="0.5" min="0" placeholder="0.0">
   </div>

   <div class="form-group">
     <label>Sleep last night (hrs)</label>
     <input id="sleep" type="number" step="0.5" min="0" max="24" placeholder="0.0">
   </div>

   <div class="form-group">
     <label>Caffeine drinks today (#)</label>
     <input id="caff" type="number" min="0" placeholder="0">
   </div>
 </div>

 <div class="section">
   <div class="form-group">
     <label>Notes</label>
     <input id="notes" style="width:100%;max-width:500px;" placeholder="Optional notes">
   </div>
 </div>

 <button onclick="saveDemo()">Continue</button>
 `);
}

function saveDemo(){
 DEMO={
   age:age.value, gender:gender.value, grade:grade.value,
   screenTime:screenTime.value, sleep:sleep.value,
   caffeine:caff.value, notes:notes.value
 };
 consent();
}

/* ================= CONSENT ================= */
function consent(){
 screen(`
 <h2>Consent</h2>
 <p>You will complete attention tasks before and after watching videos.
 ~15 minutes. You may stop anytime.</p>
 <button onclick="start()">I Agree</button>
 `);
}

/* ================= TRIALS ================= */
function makeTrials(n){
 const cong=Math.round(n*SETTINGS.pct/100);
 const incong=n-cong;
 let t=[];
 for(let i=0;i<cong/2;i++){t.push({s:"<<<<<",d:"left",c:"cong"});t.push({s:">>>>>",d:"right",c:"cong"})}
 for(let i=0;i<incong/2;i++){t.push({s:"<<><<",d:"right",c:"incong"});t.push({s:">><>>",d:"left",c:"incong"})}
 return shuffle(t).slice(0,n)
}

/* ================= BLOCK ================= */
async function runBlock(name,n,practice=false){

 await info(name+" starting");

 const trials=makeTrials(n);
 blockTotal=n;

 for(let i=0;i<trials.length;i++){

  blockIndex=i+1;

  const tr=trials[i];
  const blockTitles = {
    "practice": "Practice",
    "baseline": "Baseline",
    "post": "Post-Exposure",
    "recovery": "Recovery"
  };
  const blockTitle = blockTitles[name] || name.charAt(0).toUpperCase() + name.slice(1);

  screen(`<h2>${blockTitle} <span id="cardProgress" style="margin-left:10px;"></span></h2><div class="flanker">${tr.s}</div><div class="feedback" id="fb"></div>`);

  // update progress after card is rendered so the span exists
  updateProgress(`${blockIndex}/${blockTotal}`);

  const start=performance.now();

  const key=await new Promise(res=>{
    document.onkeydown=e=>{
      if(["f","j"].includes(e.key)){document.onkeydown=null;res(e.key)}
    }
  });

  const rt=Math.round(performance.now()-start);
  const correct=(key===(tr.d==="left"?"f":"j"));

  if(practice){
    fb.innerText = correct?"âœ” Correct":"âœ– Wrong";
    await wait(1000);
  }

  trialsData.push({
  pid,
  block:name,
  trial:blockIndex,
  congruency:tr.c,
  correct: correct?1:0,
  rt
});

 }
}

/* ================= INFO SCREEN ================= */
async function info(txt){
 screen(`<h2>${txt}</h2><button onclick="go()">Start</button>`);
 await new Promise(r=>window.go=r);
}

/* ================= EXPOSURE ================= */
async function exposure(){
 await info("Exposure starting");

 updateStatus("Exposure");

 screen(`
 <h2>Rapid Change Stimuli Exposure</h2>
 <iframe width="720" height="420" 
 src="${SETTINGS.playlist}" title="YouTube video player" frameborder="0" 
 allow="autoplay"></iframe>
 `);

 for(let i=SETTINGS.minutes*60;i>0;i--){
   updateStatus("Exposure "+i+"s");
   await wait(1000);
 }
}

/* ================= RECOVERY PAUSE ================= */
async function recoveryPause(seconds){
  seconds = Number(seconds) || 0;
  if(seconds <= 0) return;

  screen(`
    <h2>Short break</h2>
    <p>Rest for <span id="recCount">${seconds}</span> seconds before the recovery test.</p>
  `);

  for(let i=seconds;i>0;i--){
    const el = document.getElementById('recCount');
    if(el) el.innerText = i;
    updateStatus('Recovery starts in '+i+'s');
    await wait(1000);
  }
}

/* ================= SUMMARY + CHARTS ================= */
function mean(a){return a.reduce((x,y)=>x+y,0)/a.length}

function compute(block,cond){
 return mean(data.filter(d=>d.block===block && d.cong===cond && d.correct).map(d=>d.rt))
}

function summaryScreen(){

 function mean(arr){
   if(!arr.length) return 0;
   return arr.reduce((a,b)=>a+b,0)/arr.length;
 }

 function blockStats(block){

   const rows = trialsData.filter(d=>d.block===block);

   const cong = rows.filter(d=>d.congruency==="cong" && d.correct);
   const incong = rows.filter(d=>d.congruency==="incong" && d.correct);

   const rtCong = mean(cong.map(d=>d.rt));
   const rtIncong = mean(incong.map(d=>d.rt));

   return {
     rt: mean(rows.filter(d=>d.correct).map(d=>d.rt)),
     acc: mean(rows.map(d=>d.correct)),
     cost: rtIncong - rtCong
   };
 }

 const base = blockStats("baseline");
 const post = blockStats("post");
 const rec  = blockStats("recovery");

 /* ---------- build summary object ---------- */

 summaryData = {
   pid,
   ...DEMO,
   ...SETTINGS,

   baseline_cost: Math.round(base.cost),
   post_cost: Math.round(post.cost),
   recovery_cost: Math.round(rec.cost),

   delta_post: Math.round(post.cost - base.cost),
   delta_recovery: Math.round(rec.cost - base.cost),

   baseline_rt: Math.round(base.rt),
   post_rt: Math.round(post.rt),
   recovery_rt: Math.round(rec.rt),

   baseline_acc: base.acc.toFixed(3),
   post_acc: post.acc.toFixed(3),
   recovery_acc: rec.acc.toFixed(3)
 };

 screen(`
  <h2>Summary</h2>
  <p><strong>Thank you for participating!</strong></p>
  <p>
    Baseline cost: ${summaryData.baseline_cost} ms<br>
    Post cost: ${summaryData.post_cost} ms<br>
    Recovery cost: ${summaryData.recovery_cost} ms
  </p>
  <p>Results are saved and downloading started.</p>
`);

 /* change pause button to restart */
 const pauseBtn = document.getElementById("pauseBtn");
 if(pauseBtn){
   pauseBtn.innerText = "Restart";
   pauseBtn.onclick = () => location.reload();
 }

 /* export both */
 downloadCSV(trialsData, `trials_${pid}.csv`);
 downloadCSV([summaryData], `summary_${pid}.csv`);
}

function drawChart(vals){
 const ctx=c.getContext("2d");
 const max=Math.max(...vals);
 const w=150;
 vals.forEach((v,i)=>{
   const h=(v/max)*200;
   ctx.fillStyle="#4b7bec";
   ctx.fillRect(100+i*200,250-h,w,h);
   ctx.fillText(["Base","Post","Rec"][i],120+i*200,270);
 });
}

/* ================= CSV ================= */
function downloadCSV(rows, filename){

 const headers = Object.keys(rows[0]);

 let csv = headers.join(",") + "\n";

 rows.forEach(r=>{
   csv += headers.map(h=>r[h]).join(",") + "\n";
 });

 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download=filename;
 a.click();
}

/* ================= FLOW ================= */
async function start(){
 startTimer();
 await keyCheck();   // ðŸ‘ˆ NEW confirmation screen
 await runBlock("practice",SETTINGS.practice,true);
 await runBlock("baseline",SETTINGS.baseline);
 await exposure();
  await runBlock("post",SETTINGS.post);
  // short pause before recovery block if configured
  await recoveryPause(SETTINGS.recoveryDelay);
  await runBlock("recovery",SETTINGS.recovery);
 stopTimer();
 summaryScreen();
}

async function keyCheck(){
 screen(`
 <h2>Practice Instructions</h2>
 <p>
 Press <b>F</b> when the middle arrow points left.<br>
 Press <b>J</b> when the middle arrow points right.
 </p>
 <p><strong>Where to look:</strong> Keep your eyes on the <em>center (middle) arrow</em> of the stimulus.</p>
 <p>Press BOTH keys once to begin practice. Each time you press F or J the center arrow will update and be highlighted.</p>
 <div id="kstatus" style="margin-top:8px;margin-bottom:12px;"></div>
 <div class="flanker" id="kfl">
   <span class="s">&lt;</span>
   <span class="s">&lt;</span>
   <span class="s center" id="kcenter">-</span>
   <span class="s">&gt;</span>
   <span class="s">&gt;</span>
 </div>
 <style>
   #kfl{font-size:54px;letter-spacing:10px;display:inline-block;margin-top:12px}
   #kfl .s{display:inline-block;width:1ch}
   #kfl .center{padding:6px 10px;border-radius:6px;transition:background 0.12s, color 0.12s}
   #kfl .center.highlight{background:yellow;color:#111}
 </style>
 `);

 let f=false, j=false;

 const kcenter = document.getElementById('kcenter');
 const spans = Array.from(document.querySelectorAll('#kfl .s'));

 function showArrow(which){
  // which: 'left' or 'right'
  const ch = which === 'left' ? '<' : '>';
  // set surrounding flanker arrows for context
  spans.forEach((sp,i)=>{
    if(i < 2) sp.innerText = ch;
    else if(i === 2) sp.innerText = ch; // center
    else sp.innerText = ch;
  });
  // highlight only the center
  kcenter.classList.add('highlight');
  setTimeout(()=>kcenter.classList.remove('highlight'),250);
}

 await new Promise(resolve=>{
   document.onkeydown = e => {
     if(e.key !== 'f' && e.key !== 'j') return;

     if(e.key === 'f'){
       f = true;
       showArrow('left');
     }
     if(e.key === 'j'){
       j = true;
       showArrow('right');
     }

     kstatus.innerText = `F: ${f?"âœ“":""}   J: ${j?"âœ“":""}`;

     if(f && j){
       // both keys pressed: stop key listening and show Start button
       document.onkeydown = null;

      const startBtn = document.createElement('button');
      startBtn.innerText = 'Start practice';
      startBtn.id = 'startPracticeBtn';
      startBtn.style.display = 'block';
      startBtn.style.width = '180px';
      startBtn.style.margin = '12px auto';
      startBtn.style.clear = 'both';
      startBtn.style.textAlign = 'center';
       startBtn.onclick = () => {
         startBtn.remove();
         resolve();
       };

      // insert button after kfl (will render centered below because it's block)
      const kflEl = document.getElementById('kfl');
      kflEl.insertAdjacentElement('afterend', startBtn);
       kstatus.innerText += '  â€” press Start to begin';
     }
   };
 });
}


/* ================= START ================= */
setupScreen();
</script>
</body>
</html>




